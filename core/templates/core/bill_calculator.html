{% extends "core/base.html" %}

{% block content %}
<div class="min-h-screen bg-sky-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-5xl mx-auto">

        <div class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-sky-900">üçΩÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≤‡∏£ By HaanDaiBor</h1>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-2 space-y-6">
                
                <div class="bg-white rounded-2xl shadow-sm border border-sky-100 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô (Members)</h3>
                    
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="new-person-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô A, B, C)" 
                               class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-300 outline-none"
                               onkeydown="if(event.key === 'Enter') addPerson()">
                        <button onclick="addPerson()" class="bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded-lg font-bold transition-colors">
                            + ‡πÄ‡∏û‡∏¥‡πà‡∏°
                        </button>
                    </div>

                    <div id="people-list" class="flex flex-wrap gap-2">
                        <span class="text-gray-400 text-sm italic p-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</span>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-sky-100 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div class="md:col-span-2">
                            <label class="text-xs text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                            <input type="text" id="item-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πâ‡∏°‡∏ï‡∏≥, ‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á" 
                                   class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-300 outline-none">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤</label>
                            <input type="number" id="item-price" placeholder="0.00" 
                                   class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-300 outline-none text-right">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="text-xs text-gray-500 mb-2 block">‡πÉ‡∏Ñ‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ö‡πâ‡∏≤‡∏á? (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏´‡∏≤‡∏£)</label>
                        <div id="payer-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <span class="text-gray-400 text-xs col-span-full text-center">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠ 1 ‡∏Å‡πà‡∏≠‡∏ô</span>
                        </div>
                        <div class="mt-2 flex gap-2">
                             <button onclick="toggleSelectAll(true)" class="text-xs text-sky-600 hover:underline">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                             <span class="text-gray-300">|</span>
                             <button onclick="toggleSelectAll(false)" class="text-xs text-sky-600 hover:underline">‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏¢</button>
                        </div>
                    </div>

                    <button onclick="addItem()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-md transition-all transform active:scale-95">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ö‡∏¥‡∏•
                    </button>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-sky-100 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 rounded-l-lg">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th class="px-4 py-2 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                                    <th class="px-4 py-2">‡∏Ñ‡∏ô‡∏´‡∏≤‡∏£</th>
                                    <th class="px-4 py-2 rounded-r-lg text-center">‡∏•‡∏ö</th>
                                </tr>
                            </thead>
                            <tbody id="items-table-body">
                                </tbody>
                            <tfoot class="font-bold text-gray-900 border-t-2 border-gray-100">
                                <tr>
                                    <td class="px-4 py-3">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
                                    <td class="px-4 py-3 text-right" id="total-food-price">0.00</td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

            </div>

            <div class="space-y-6">
                
                <div class="bg-white rounded-2xl shadow-sm border border-sky-100 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between cursor-pointer">
                            <span class="text-gray-700">Service Charge (10%)</span>
                            <input type="checkbox" id="svc-check" onchange="calculateTotal()" class="w-5 h-5 text-sky-600 rounded">
                        </label>
                        <label class="flex items-center justify-between cursor-pointer">
                            <span class="text-gray-700">VAT (7%)</span>
                            <input type="checkbox" id="vat-check" onchange="calculateTotal()" class="w-5 h-5 text-sky-600 rounded" checked>
                        </label>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-sky-600 to-indigo-700 rounded-2xl shadow-xl p-6 text-white sticky top-6">
                    <h3 class="text-xl font-bold mb-4 border-b border-white/20 pb-2">üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢</h3>
                    
                    <div id="summary-container" class="space-y-3">
                        <div class="text-center text-sky-100 py-4 opacity-70">
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                        </div>
                    </div>

                    <div class="mt-6 pt-4 border-t border-white/30">
                        <div class="flex justify-between items-end">
                            <span class="text-sky-100">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                            <span class="text-3xl font-extrabold text-yellow-300" id="grand-total">0.00</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        
        <div class="mt-8 text-center">
            <a href="{% url 'home' %}" class="text-sky-600 hover:text-sky-800 font-medium">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        </div>

    </div>
</div>

<script>
    // State ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    let people = []; // ['Alice', 'Bob']
    let items = [];  // [{name: 'Pizza', price: 200, payers: ['Alice', 'Bob']}]

    // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô (People)
    function addPerson() {
        const input = document.getElementById('new-person-name');
        const name = input.value.trim();
        
        if (name && !people.includes(name)) {
            people.push(name);
            input.value = '';
            renderPeople();
            renderPayerCheckboxes(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï checkbox ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            calculateTotal(); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö
        } else if (people.includes(name)) {
            alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
        }
    }

    function removePerson(name) {
        if(confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏∏‡∏ì "${name}" ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
            people = people.filter(p => p !== name);
            // ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢
            items.forEach(item => {
                item.payers = item.payers.filter(p => p !== name);
            });
            renderPeople();
            renderPayerCheckboxes();
            renderItemsTable();
            calculateTotal();
        }
    }

    function renderPeople() {
        const container = document.getElementById('people-list');
        if (people.length === 0) {
            container.innerHTML = '<span class="text-gray-400 text-sm italic p-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</span>';
            return;
        }
        
        let html = '';
        people.forEach(p => {
            html += `
                <div class="flex items-center bg-sky-100 text-sky-800 px-3 py-1 rounded-full text-sm font-bold border border-sky-200">
                    ${p}
                    <button onclick="removePerson('${p}')" class="ml-2 text-sky-400 hover:text-red-500 font-normal">√ó</button>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function renderPayerCheckboxes() {
        const container = document.getElementById('payer-checkboxes');
        if (people.length === 0) {
            container.innerHTML = '<span class="text-gray-400 text-xs col-span-full text-center">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠ 1 ‡∏Å‡πà‡∏≠‡∏ô</span>';
            return;
        }

        let html = '';
        people.forEach((p, index) => {
            html += `
                <label class="flex items-center space-x-2 bg-white p-2 rounded border border-gray-200 cursor-pointer hover:bg-sky-50 transition-colors">
                    <input type="checkbox" value="${p}" class="payer-checkbox w-4 h-4 text-sky-600 rounded focus:ring-sky-500">
                    <span class="text-sm text-gray-700 truncate">${p}</span>
                </label>
            `;
        });
        container.innerHTML = html;
    }
    
    function toggleSelectAll(select) {
        document.querySelectorAll('.payer-checkbox').forEach(cb => cb.checked = select);
    }

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Items)
    function addItem() {
        const nameInput = document.getElementById('item-name');
        const priceInput = document.getElementById('item-price');
        
        const name = nameInput.value.trim() || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
        const price = parseFloat(priceInput.value);

        // ‡∏´‡∏≤‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        const checkboxes = document.querySelectorAll('.payer-checkbox:checked');
        const selectedPayers = Array.from(checkboxes).map(cb => cb.value);

        if (isNaN(price) || price <= 0) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            return;
        }
        if (selectedPayers.length === 0) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ');
            return;
        }

        items.push({
            id: Date.now(),
            name: name,
            price: price,
            payers: selectedPayers
        });

        // Reset inputs
        nameInput.value = '';
        priceInput.value = '';
        toggleSelectAll(false); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå checkbox

        renderItemsTable();
        calculateTotal();
    }

    function removeItem(id) {
        items = items.filter(item => item.id !== id);
        renderItemsTable();
        calculateTotal();
    }

    function renderItemsTable() {
        const tbody = document.getElementById('items-table-body');
        const tfoot = document.getElementById('total-food-price');
        
        let html = '';
        let totalFood = 0;

        items.forEach(item => {
            totalFood += item.price;
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á text ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏´‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô "A, B (+2)")
            let payersText = item.payers.slice(0, 3).join(', ');
            if (item.payers.length > 3) payersText += ` ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${item.payers.length - 3} ‡∏Ñ‡∏ô`;
            
            html += `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-4 py-2 font-medium text-gray-900">${item.name}</td>
                    <td class="px-4 py-2 text-right">${item.price.toLocaleString()}</td>
                    <td class="px-4 py-2 text-gray-500 text-xs">
                        <span class="bg-gray-100 px-2 py-1 rounded text-gray-600">‡∏´‡∏≤‡∏£ ${item.payers.length}</span>
                        <span class="ml-1">${payersText}</span>
                    </td>
                    <td class="px-4 py-2 text-center">
                        <button onclick="removeItem(${item.id})" class="text-red-400 hover:text-red-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
        tfoot.innerText = totalFood.toLocaleString('th-TH', {minimumFractionDigits: 2});
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô (Core Logic)
    function calculateTotal() {
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô
        let personTotals = {}; 
        people.forEach(p => personTotals[p] = 0);

        let totalFood = 0;

        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        items.forEach(item => {
            totalFood += item.price;
            const splitPrice = item.price / item.payers.length; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ
            
            item.payers.forEach(payer => {
                if (personTotals[payer] !== undefined) {
                    personTotals[payer] += splitPrice;
                }
            });
        });

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì VAT/Service
        const hasService = document.getElementById('svc-check').checked;
        const hasVat = document.getElementById('vat-check').checked;

        let grandTotal = 0;
        let summaryHtml = '';

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
        if (people.length > 0) {
            people.forEach(p => {
                let baseAmount = personTotals[p] || 0;
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏°
                let svcAmount = hasService ? baseAmount * 0.10 : 0;
                let vatAmount = hasVat ? (baseAmount + svcAmount) * 0.07 : 0;
                let finalAmount = baseAmount + svcAmount + vatAmount;
                
                grandTotal += finalAmount;

                summaryHtml += `
                    <div class="flex justify-between items-center bg-white/10 p-2 rounded-lg">
                        <span class="font-bold">${p}</span>
                        <div class="text-right">
                            <span class="block font-bold text-lg">${finalAmount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                    </div>
                `;
            });
        } else {
            summaryHtml = '<div class="text-center text-sky-100 py-4 opacity-70">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô</div>';
        }

        document.getElementById('summary-container').innerHTML = summaryHtml;
        document.getElementById('grand-total').innerText = grandTotal.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // Initial Render
    renderPeople();
    renderPayerCheckboxes();
</script>
{% endblock %}