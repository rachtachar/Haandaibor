{% extends "core/base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">
    <div class="bg-white rounded-lg shadow-md h-[80vh] flex flex-col border border-gray-200">
        
        <div class="p-4 border-b bg-gradient-to-r from-blue-500 to-cyan-500 rounded-t-lg flex justify-between items-center text-white">
            <div>
                <h1 class="text-xl font-bold">üí¨ {{ post.title }}</h1>
                <p class="text-xs opacity-90">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: {{ post.members.count|add:"1" }} ‡∏Ñ‡∏ô</p>
            </div>
            <a href="{% url 'post-detail' post.pk %}" class="text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full transition">
                &larr; ‡∏Å‡∏•‡∏±‡∏ö
            </a>
        </div>

        <div id="chat-container" class="flex-1 p-6 overflow-y-auto flex flex-col space-y-3 bg-gray-50">
            <p class="text-center text-gray-400 mt-10 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</p>
        </div>

        <div class="p-4 border-t bg-white rounded-b-lg">
            <form id="chat-form" class="flex items-center space-x-2">
                {% csrf_token %}
                <input type="text" name="message" id="message-input" required autocomplete="off"
                       class="flex-grow border border-gray-300 rounded-full px-5 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm"
                       placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
                
                <button type="submit" class="bg-blue-600 text-white font-bold p-3 rounded-full hover:bg-blue-700 transition duration-200 shadow-md flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    const postId = {{ post.pk }};
    const chatContainer = document.getElementById('chat-container');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    
    let isFirstLoad = true;
    let lastMessageCount = 0;

    // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (GET)
    function fetchMessages() {
        fetch(`/post/${postId}/chat/api/get/`)
            .then(response => response.json())
            .then(data => {
                if (data.messages) {
                    renderMessages(data.messages);
                }
            })
            .catch(err => console.error('Error fetching messages:', err));
    }

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    function renderMessages(messages) {
        // ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö)
        if (messages.length === lastMessageCount && !isFirstLoad) return;
        
        lastMessageCount = messages.length;

        // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° loading ‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        const loadingText = document.querySelector('.animate-pulse');
        if (loadingText) loadingText.remove();
        
        if (messages.length === 0) {
            chatContainer.innerHTML = '<p class="text-center text-gray-400 mt-10">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</p>';
            return;
        }

        let html = '';
        messages.forEach(msg => {
            if (msg.is_me) {
                // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏≤ (‡∏Ç‡∏ß‡∏≤)
                html += `
                    <div class="flex justify-end mb-2">
                        <div class="bg-blue-600 text-white px-4 py-2 rounded-2xl rounded-tr-none max-w-[75%] shadow-sm">
                            <p class="text-sm">${msg.message}</p>
                            <p class="text-[10px] text-blue-100 text-right mt-1">${msg.timestamp}</p>
                        </div>
                    </div>`;
            } else {
                // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô (‡∏ã‡πâ‡∏≤‡∏¢)
                html += `
                    <div class="flex justify-start items-end space-x-2 mb-2">
                        <img class="h-8 w-8 rounded-full object-cover border border-gray-300 shadow-sm" src="${msg.profile_url}" alt="${msg.user}">
                        <div>
                            <p class="text-[10px] text-gray-500 ml-2 mb-0.5">${msg.user}</p>
                            <div class="bg-white text-gray-800 px-4 py-2 rounded-2xl rounded-tl-none max-w-xs shadow-sm border border-gray-100">
                                <p class="text-sm">${msg.message}</p>
                                <p class="text-[10px] text-gray-400 text-right mt-1">${msg.timestamp}</p>
                            </div>
                        </div>
                    </div>`;
            }
        });

        chatContainer.innerHTML = html;

        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        if (isFirstLoad) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
            isFirstLoad = false;
        }
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (POST)
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        const formData = new FormData(chatForm);

        fetch(`/post/${postId}/chat/api/send/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                messageInput.value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
                fetchMessages(); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ 2 ‡∏ß‡∏¥)
                setTimeout(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 100);
            }
        })
        .catch(err => console.error('Error sending message:', err));
    });

    // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---
    fetchMessages(); // ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    setInterval(fetchMessages, 2000); // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (Polling)

</script>
{% endblock %}