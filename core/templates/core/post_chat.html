{% extends "core/base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6 h-[calc(100vh-80px)]">
    <div
        class="bg-white/90 backdrop-blur-md rounded-3xl shadow-2xl shadow-sky-200/50 h-full flex flex-col border border-sky-100 overflow-hidden">

        <div
            class="p-4 border-b border-sky-100 bg-gradient-to-r from-sky-50 to-white flex justify-between items-center relative z-10">
            <div class="flex items-center gap-3">
                <a href="{% url 'post-detail' post.pk %}"
                    class="p-2 rounded-full hover:bg-sky-100 text-sky-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </a>
                <div>
                    <h1 class="text-lg font-bold text-sky-900 truncate max-w-[200px] md:max-w-md">üí¨ {{ post.title }}
                    </h1>
                    <p class="text-xs text-sky-500">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: {{ post.members.count|add:"1" }} ‡∏Ñ‡∏ô</p>
                </div>
            </div>
        </div>

        <div id="chat-container" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-4 bg-sky-50/30 scroll-smooth">
            <div class="flex justify-center items-center h-full">
                <p class="text-sky-400 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</p>
            </div>
        </div>

        <div class="p-4 bg-white border-t border-sky-100">
            <form id="chat-form" class="flex items-end gap-2" enctype="multipart/form-data">
                {% csrf_token %}

                <label for="chat-image-input"
                    class="p-3 text-sky-500 hover:text-sky-700 hover:bg-sky-50 rounded-full cursor-pointer transition-colors relative group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span
                        class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 text-xs text-white bg-sky-800 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
                </label>

                <input type="file" name="image" id="chat-image-input" class="hidden" accept="image/*">

                <div class="flex-grow relative">
                    <div id="image-preview-container"
                        class="hidden absolute bottom-full left-0 mb-2 p-2 bg-white rounded-lg shadow-lg border border-sky-100">
                        <div class="relative">
                            <img id="image-preview" src="" alt="Preview" class="max-h-32 rounded-md object-cover">
                            <button type="button" id="remove-image-btn"
                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-sm hover:bg-red-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <input type="text" name="message" id="message-input" autocomplete="off"
                        class="w-full border border-sky-200 rounded-full px-5 py-3 focus:outline-none focus:ring-2 focus:ring-sky-300 focus:border-transparent placeholder-sky-300 text-sky-900 bg-sky-50/50"
                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
                </div>

                <button type="submit"
                    class="bg-gradient-to-r from-sky-400 to-blue-500 text-white p-3 rounded-full hover:from-sky-500 hover:to-blue-600 transition-all shadow-md transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                    id="send-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                        class="w-6 h-6 rotate-[-45deg] translate-x-0.5 -translate-y-0.5">
                        <path
                            d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    const postId = "{{ post.pk }}";
    const chatContainer = document.getElementById('chat-container');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const imageInput = document.getElementById('chat-image-input');
    const previewContainer = document.getElementById('image-preview-container');
    const previewImage = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');

    let isFirstLoad = true;
    let lastMessageCount = 0;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ---
    imageInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                previewImage.src = e.target.result;
                previewContainer.classList.remove('hidden');
            }
            reader.readAsDataURL(file);
        }
    });

    removeImageBtn.addEventListener('click', function () {
        imageInput.value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå input file
        previewContainer.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô preview
    });

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Polling) ---
    function fetchMessages() {
        fetch(`/post/${postId}/chat/api/get/`)
            .then(response => response.json())
            .then(data => {
                if (data.messages) {
                    renderMessages(data.messages);
                }
            })
            .catch(err => console.error('Error fetching messages:', err));
    }

    function renderMessages(messages) {
        if (messages.length === lastMessageCount && !isFirstLoad) return;
        lastMessageCount = messages.length;

        // ‡∏•‡∏ö loading text ‡∏≠‡∏≠‡∏Å
        if (chatContainer.querySelector('.animate-pulse')) {
            chatContainer.innerHTML = '';
        }

        if (messages.length === 0) {
            chatContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-sky-300 opacity-70">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                    <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</p>
                </div>`;
            return;
        }

        let html = '';
        messages.forEach(msg => {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const imageHtml = msg.image_url ?
                `<a href="${msg.image_url}" target="_blank">
                    <img src="${msg.image_url}" class="rounded-lg mt-1 max-w-xs max-h-60 object-cover border border-sky-100 hover:opacity-90 transition-opacity">
                 </a>` : '';

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏ï‡πà‡∏£‡∏π‡∏õ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏á)
            const textHtml = msg.message ? `<p class="text-sm leading-relaxed">${msg.message}</p>` : '';

            if (msg.is_me) {
                // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏≤ (‡∏Ç‡∏ß‡∏≤)
                html += `
                    <div class="flex justify-end mb-2 group">
                        <div class="max-w-[75%]">
                            <div class="bg-gradient-to-br from-sky-500 to-blue-600 text-white px-4 py-2.5 rounded-2xl rounded-tr-none shadow-md">
                                ${imageHtml}
                                ${textHtml}
                            </div>
                            <p class="text-[10px] text-sky-400 text-right mt-1 opacity-0 group-hover:opacity-100 transition-opacity mr-1">${msg.timestamp}</p>
                        </div>
                    </div>`;
            } else {
                // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô (‡∏ã‡πâ‡∏≤‡∏¢)
                html += `
                    <div class="flex justify-start items-end space-x-2 mb-2 group">
                        <img class="h-8 w-8 rounded-full object-cover border-2 border-white shadow-sm" src="${msg.profile_url}" alt="${msg.user}">
                        <div class="max-w-[75%]">
                            <p class="text-[10px] text-sky-600 ml-2 mb-0.5 font-medium">${msg.user}</p>
                            <div class="bg-white text-gray-700 px-4 py-2.5 rounded-2xl rounded-tl-none shadow-sm border border-sky-100">
                                ${imageHtml}
                                ${textHtml}
                            </div>
                            <p class="text-[10px] text-sky-300 mt-1 opacity-0 group-hover:opacity-100 transition-opacity ml-1">${msg.timestamp}</p>
                        </div>
                    </div>`;
            }
        });

        chatContainer.innerHTML = html;

        if (isFirstLoad) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
            isFirstLoad = false;
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡πà‡∏≤‡πÜ ‡πÉ‡∏´‡πâ Auto Scroll ‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á
            if (chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 200) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (POST) ---
    chatForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const message = messageInput.value.trim();
        const hasImage = imageInput.files.length > 0;

        // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á
        if (!message && !hasImage) return;

        const formData = new FormData(chatForm);

        fetch(`/post/${postId}/chat/api/send/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    messageInput.value = '';
                    imageInput.value = '';
                    previewContainer.classList.add('hidden');
                    previewImage.src = '';

                    fetchMessages(); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    setTimeout(() => {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }, 100);
                }
            })
            .catch(err => console.error('Error sending message:', err));
    });

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    fetchMessages();
    setInterval(fetchMessages, 2000); // Polling ‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥

</script>
{% endblock %}